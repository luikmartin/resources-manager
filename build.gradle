// Multi-module build configuration for the parent project
plugins {
    id 'org.springframework.boot' version '3.5.3' apply false
    id 'io.spring.dependency-management' version '1.1.7' apply false
    id 'base'
    id 'jacoco' // Add JaCoCo for code coverage
}

ext {
    versions = [springBoot                : '3.5.3',
                springDependencyManagement: '1.1.7',
                lombok                    : '1.18.30',
                jetbrainsAnnotations      : '24.1.0',
                liquibase                 : '4.27.0',
                springdoc                 : '2.8.0',
                testcontainers            : '1.20.3']

    libs = [springBootStarter          : "org.springframework.boot:spring-boot-starter",
            springBootStarterWeb       : "org.springframework.boot:spring-boot-starter-web",
            springBootStarterActuator  : "org.springframework.boot:spring-boot-starter-actuator",
            springBootStarterDataJpa   : "org.springframework.boot:spring-boot-starter-data-jpa",
            springBootStarterValidation: "org.springframework.boot:spring-boot-starter-validation",
            springBootStarterTest      : "org.springframework.boot:spring-boot-starter-test",
            springBootStarterKafka     : "org.springframework.kafka:spring-kafka",

            jacksonDatabind            : "com.fasterxml.jackson.core:jackson-databind",
            jacksonCore                : "com.fasterxml.jackson.core:jackson-core",
            jacksonDatatypeJsr310      : "com.fasterxml.jackson.datatype:jackson-datatype-jsr310",
            lombok                     : "org.projectlombok:lombok",
            jetbrainsAnnotations       : "org.jetbrains:annotations:${versions.jetbrainsAnnotations}",
            hibernateValidator         : "org.hibernate.validator:hibernate-validator",
            postgresql                 : "org.postgresql:postgresql",
            liquibaseCore              : "org.liquibase:liquibase-core:${versions.liquibase}",
            springdocOpenapi           : "org.springdoc:springdoc-openapi-starter-webmvc-ui:${versions.springdoc}",
            testcontainersPostgresql   : "org.testcontainers:postgresql:${versions.testcontainers}",
            testcontainersJunitJupiter : "org.testcontainers:junit-jupiter:${versions.testcontainers}",
            testcontainersKafka        : "org.testcontainers:kafka:${versions.testcontainers}"]
}

allprojects {
    group = 'com.martinluik'
    version = '0.0.1-SNAPSHOT'

    repositories {
        mavenCentral()
    }
}

subprojects {
    apply plugin: 'java'
    apply plugin: 'io.spring.dependency-management'
    apply plugin: 'jacoco'

    java {
        toolchain {
            languageVersion = JavaLanguageVersion.of(21)
        }
    }

    configurations {
        compileOnly {
            extendsFrom annotationProcessor
        }
    }

    dependencyManagement {
        imports {
            mavenBom "org.springframework.boot:spring-boot-dependencies:${versions.springBoot}"
        }
    }

    dependencies {
        compileOnly libs.lombok
        annotationProcessor libs.lombok
    }

    tasks.named('test') {
        useJUnitPlatform()
        jvmArgs '-XX:+EnableDynamicAgentLoading'
    }

    jacoco {
        toolVersion = "0.8.11"
    }

    tasks.withType(Test) {
        finalizedBy jacocoTestReport
    }

    jacocoTestReport {
        dependsOn test
        reports {
            xml.required = true
            html.required = true
        }
    }

    tasks.named('clean') {
        delete 'build', 'out'
        delete 'src/main/generated'
    }
}

// Root project task configurations
if (project == rootProject) {
    // Configure root test task to run unit tests from all subprojects
    tasks.register('test') {
        description = 'Runs unit tests from all subprojects'
        group = 'verification'
        
        // This will run test tasks from all subprojects
        dependsOn subprojects.collect { it.tasks.named('test') }
    }
    
    // Configure root integrationTest task to run integration tests from api module only
    tasks.register('integrationTest') {
        description = 'Runs integration tests from the api module'
        group = 'verification'
        
        // Only run integrationTest from api module
        dependsOn project(':api').tasks.named('integrationTest')
        
        // Make sure unit tests run before integration tests
        mustRunAfter test
    }

    tasks.named('clean') {
        dependsOn subprojects.collect { it.tasks.named('clean') }
        delete 'build', 'out'
        delete 'src/main/generated'
    }
    
    tasks.named('build') {
        dependsOn subprojects.collect { it.tasks.named('build') }
    }
    
    // Configure check task to run both unit and integration tests
    tasks.named('check') {
        dependsOn test, integrationTest
    }
}
